name: Auto Deploy to EC2

on:
 push:
  branches:
   - main


jobs:
 deploy:
  runs-on: ubuntu-latest
  steps:
   - name: Checkout code
     uses: actions/checkout@v2

   - name: SSH and Deploy
     uses: appleboy/ssh-action@master
     with:
      host: ${{ secrets.HOST }}
      username: ${{ secrets.USERNAME }}
      key: ${{ secrets.SSH_KEY }}
      script: |
        cdã€€fit_fidner &&
        git pull origin main &&
        bundle exec rails assets:precompile RAILS_ENV=production &&
        sudo kill $(cat tmp/pids/puma.pid) &&
        bundle exec rails s -e production -d